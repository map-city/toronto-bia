<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<meta charset="UTF-8" />
	<script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>
	<link href="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
	<link rel="stylesheet" href="style.css">
	<title>Toronto BIA</title>
</head>

<body>
	<div id="map"></div>

	<script>

		const locationFile = 'data/directory/downtownwest.geojson'
		const featureIds = ['concat', ['get', 'name'], '|']
		let locationData;
		let currentPopup = null;

		var map = new maplibregl.Map({
			container: 'map',
			style: 'style.json',
			center: [-79.39253, 43.64397],
			pixelRatio: 1,
			zoom: 15,
			minZoom: 14,
			maxZoom: 18,
			bearing: -16,
			pitch: 40,
			hash: true
		});

		map.on('load', async () => {

			// Load points data
			const pointsResponse = await fetch(locationFile);
			const pointsData = await pointsResponse.json();

			// Set locationData
			locationData = pointsData.features;

			// Add buildings source
			map.addSource('toronto_buildings', {
				type: 'vector',
				tiles: ['https://mapcity.io/toronto-bia/data/toronto_buildings/{z}/{x}/{y}.pbf']
			});

			// Add bia source
			map.addSource('toronto_bia', {
				'type': 'geojson',
				'data': 'https://mapcity.io/toronto-bia/data/opendata-to/BusinessImprovementAreas-4326.geojson'
			});

			// Add places source
			map.addSource('places', {
				'type': 'geojson',
				'data': pointsData,
				'cluster': true,
				'clusterRadius': 30,
				'clusterMaxZoom': 18,
				'clusterMinPoints': 2,
				'clusterProperties': {
					'featureIds': ['concat', featureIds]
				}
			});

			// Add bia outline
			map.addLayer({
				'id': 'toronto-bia',
				'source': 'toronto_bia',
				"filter": ["in", "AREA_NAME", "Toronto Downtown West"],
				'type': 'line',
				'paint': {
					'line-color': 'hsl(0, 0%, 40%)',
					'line-width': 5,
					'line-opacity': ['interpolate', ['linear'], ['zoom'], 14, 0.3, 17, 0.3, 18, 0],
				}
			});

			// Add building outlines
			map.addLayer({
				'id': 'buildings-outline',
				'source': 'toronto_buildings',
				'source-layer': 'toronto_buildings',
				'type': 'fill',
				'paint': {
					'fill-color': 'hsl(0, 0%, 85%)',
					'fill-opacity': ["interpolate", ["linear"], ["zoom"], 16, 0, 18, 1]
				},
				'minzoom': 16
			}, 'highway-name-minor');

			// Add 3d buildings
			map.addLayer({
				'id': 'buildings',
				'source': 'toronto_buildings',
				'source-layer': 'toronto_buildings',
				'type': 'fill-extrusion',
				'paint': {
					'fill-extrusion-color': 'hsl(0, 0%, 85%)',
					'fill-extrusion-height': [
						'case',
						['!=', ['get', 'max_height'], null], ['get', 'max_height'],
						['!=', ['get', 'avg_height'], null], ['get', 'avg_height'],
						10
					],
					'fill-extrusion-base': 0,
					'fill-extrusion-opacity': ['interpolate', ['linear'], ['zoom'], 15, 0, 16, 0.3, 17, 0.3, 18, 0]
				},
				'minzoom': 15
			}, 'highway-name-minor');

			// Add point halos
			map.addLayer({
				id: 'points-halo',
				type: 'circle',
				source: 'places',
				filter: ['!', ['has', 'point_count']],
				paint: {
					'circle-radius': 16,
					'circle-color': 'hsl(0, 0%, 100%)',
					'circle-opacity': 0.5,
					'circle-stroke-width': 0,
					'circle-stroke-color': 'hsl(180, 21%, 5%)'
				}
			});

			// Add points
			map.addLayer({
				id: 'points',
				type: 'circle',
				source: 'places',
				filter: ['!', ['has', 'point_count']],
				paint: {
					'circle-radius': 10,
					'circle-color': [
						"case",
						["==", ["get", "business_type"], "accomodations"], "#000000",
						["==", ["get", "business_type"], "attractions"], "#dd9933",
						["==", ["get", "business_type"], "bakery"], "#9ad66f",
						["==", ["get", "business_type"], "bars"], "#841d1d",
						["==", ["get", "business_type"], "comedy"], "#eeee22",
						["==", ["get", "business_type"], "grocery"], "#ddb982",
						["==", ["get", "business_type"], "night-clubs-entertainment-venues"], "#8224e3",
						["==", ["get", "business_type"], "pubs-bars"], "#841d1d",
						["==", ["get", "business_type"], "quick-serve"], "#eded78",
						["==", ["get", "business_type"], "restaurants"], "#dd5454",
						["==", ["get", "business_type"], "retail"], "#9ad66f",
						["==", ["get", "business_type"], "services"], "#5b90bf",
						"hsl(0, 0%, 0%)"
					],
					'circle-stroke-width': 0,
					'circle-stroke-color': 'hsl(180, 21%, 5%)'
				}
			});

			// Add point symbols
			map.addLayer({
				id: 'points-symbols',
				type: 'symbol',
				source: 'places',
				filter: ['!', ['has', 'point_count']],
				layout: {
					"icon-size": 0.5,
					"symbol-placement": "point",
					"icon-image": ["match", ["get", "business_type"], "restaurants", "icon-restaurant", "retail", "icon-shop", "services", "icon-community", "quick-serve", "icon-doityourself", "night-clubs-entertainment-venues", "icon-nightclub", "accommodations", "icon-chalet", "bakery", "icon-bakery", "pubs-bars", "icon-bar", "attractions", "icon-monument", "grocery", "icon-greengrocer", "bar", "icon-bar", "comedy", "icon-theatre", "unknown" ],
					"icon-anchor": "center",
					"icon-allow-overlap": false,
					"icon-ignore-placement": false,
					"icon-optional": false
				},
				paint: {
					"icon-opacity": 1,
					"icon-color": 'hsl(0, 0%, 100%)'
				}
			});

			// Add cluster halos
			map.addLayer({
				id: 'clusters-halo',
				type: 'circle',
				source: 'places',
				filter: ['has', 'point_count'],
				paint: {
					'circle-color': [
						'step',
						['get', 'point_count'],
						'hsl(0, 0%, 100%)',
						10, 'hsl(0, 0%, 100%)',
						25, 'hsl(0, 0%, 100%)'
					],
					'circle-opacity': 0.5,
					'circle-radius': [
						'step',
						['get', 'point_count'],
						18,
						10, 22,
						25, 26
					],
					'circle-stroke-width': 0,
					'circle-stroke-color': 'hsl(180, 21%, 5%)',
				}
			});

			// Add clusters
			map.addLayer({
				id: 'clusters',
				type: 'circle',
				source: 'places',
				filter: ['has', 'point_count'],
				paint: {
					'circle-color': [
						'step',
						['get', 'point_count'],
						'hsl(0, 0%, 50%)',
						10, 'hsl(0, 0%, 50%)',
						25, 'hsl(0, 0%, 50%)'
					],
					'circle-radius': [
						'step',
						['get', 'point_count'],
						10,
						10, 14,
						25, 18
					],
					'circle-stroke-width': 0,
					'circle-stroke-color': 'hsl(180, 21%, 5%)',
				}
			});

			// Add cluster counts
			map.addLayer({
				id: 'cluster-count',
				type: 'symbol',
				source: 'places',
				filter: ['has', 'point_count'],
				layout: {
					'text-field': '{point_count_abbreviated}',
					'text-font': ['montserrat-semibold'],
					'text-size': 14,
					'text-anchor': 'center',
					'text-offset': [0, 0.01],
					'text-allow-overlap': true,
					'text-ignore-placement': true
				},
				paint: {
					'text-color': 'hsl(0, 0%, 100%)'
				}
			});

			map.setLight({
				'anchor': 'viewport',
				'color': 'hsl(0, 0%, 100%)',
				'intensity': 0.5,
				'position': [1.15, 210, 20]
			});

			// Add pointer cursor for both points and clusters on hover
			map.on('mouseenter', ['points-halo', 'clusters-halo'], () => {
				map.getCanvas().style.cursor = 'pointer';
			});

			// Reset cursor when mouse leaves
			map.on('mouseleave', ['points-halo', 'clusters-halo'], () => {
				map.getCanvas().style.cursor = '';
			});

			// map.once('idle', () => {

			// });

		});


	</script>
</body>

</html>