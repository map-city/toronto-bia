<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<meta charset="UTF-8" />
	<script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>
	<link href="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
	<link rel="stylesheet" href="style.css">
	<title>Toronto BIA</title>
</head>

<body>
	<div id="map"></div>

	<script>

		const locationFile = 'data/directory/downtownwest.geojson'
		const zoomThreshold = 18
		const imgSource = 'img'
		const featureIds = ['concat', ['get', 'api_id'], '|']
		let currentActiveCategory = 'all';
		let popupOpen = false;
		let locationData;

		var map = new maplibregl.Map({
			container: 'map',
			style: 'style.json',
			center: [-79.37773, 43.64429],
			pixelRatio: 1,
			zoom: 13,
			//minZoom: 12,
			//maxZoom: 18,
			bearing: 0,
			pitch: 40,
			hash: true
		});

		map.on('load', async () => {

			// Load points data
			const pointsResponse = await fetch(locationFile);
			const pointsData = await pointsResponse.json();

			// Set locationData
			locationData = pointsData.features;

			// Add building source
			map.addSource('toronto_buildings', {
				type: 'vector',
				tiles: ['https://mapcity.io/toronto-bia/data/toronto_buildings/{z}/{x}/{y}.pbf']
			});

			// Add neighborhood source
			map.addSource('toronto_neighborhoods', {
				type: 'vector',
				tiles: ['https://mapcity.io/toronto-bia/data/toronto_neighborhoods/{z}/{x}/{y}.pbf']
			});

			// Add neighborhood centroids
			map.addSource('toronto_neighborhoods_centroids', {
				type: 'geojson',
				data: 'https://mapcity.io/toronto-bia/data/toronto_neighborhoods_centroids.geojson'
			});

			// Add event source
			map.addSource('events', {
				'type': 'geojson',
				'data': pointsData,
				'cluster': true,
				'clusterRadius': 30,
				'clusterMinPoints': 2,
				'clusterMaxZoom': zoomThreshold,
				'clusterProperties': {
					'featureIds': ['concat', featureIds]
				}
			});

			// Add neighborhood outlines
			map.addLayer({
				'id': 'neighborhoods-outlines',
				'source': 'toronto_neighborhoods',
				'source-layer': 'toronto_neighborhoods',
				'type': 'line',
				'paint': {
					'line-color': 'hsl(227, 89%, 90%)',
					'line-width': ['interpolate', ['exponential', 1.5], ['zoom'], 11, 1, 18, 20],
					'line-opacity': ['interpolate', ['linear'], ['zoom'], 11, 0, 12, 0.1, 14, 0.2, 15, 0]
				},
				"minzoom": 11,
				"maxzoom": 15
			});

			// Add building outlines
			map.addLayer({
				'id': 'buildings-outline',
				'source': 'toronto_buildings',
				'source-layer': 'toronto_buildings',
				'type': 'line',
				'paint': {
					'line-color': 'hsl(280, 10%, 40%)',
					'line-width': 2,
					'line-opacity': ["interpolate", ["linear"], ["zoom"], 16, 0, 18, 1]
				},
				'minzoom': 16
			}, 'highway-name-minor');

			// Add 3d buildings
			map.addLayer({
				'id': 'buildings',
				'source': 'toronto_buildings',
				'source-layer': 'toronto_buildings',
				'type': 'fill-extrusion',
				'paint': {
					'fill-extrusion-color': 'hsl(280, 10%, 40%)',
					'fill-extrusion-height': [
						'case',
						['!=', ['get', 'max_height'], null], ['get', 'max_height'],
						['!=', ['get', 'avg_height'], null], ['get', 'avg_height'],
						10
					],
					'fill-extrusion-base': 0,
					'fill-extrusion-opacity': ['interpolate', ['linear'], ['zoom'], 15, 0, 16, 0.7, 17, 0.7, 18, 0]
				},
				'minzoom': 15
			}, 'highway-name-minor');

			// Add neighborhood labels
			map.addLayer({
				id: 'neighborhoods-labels',
				type: 'symbol',
				source: 'toronto_neighborhoods_centroids',
				layout: {
					'text-field': ['get', 'area_name'],
					'text-size': ['interpolate', ['exponential', 1.1], ['zoom'], 10, 1, 18, 50],
					'text-font': ['montserrat-semibold'],
					'text-max-width': 5,
					'text-line-height': 1,
					'text-allow-overlap': true,
					'text-ignore-placement': true,
					//'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
					'text-rotation-alignment': 'viewport',
					'text-pitch-alignment': 'viewport'
				},
				paint: {
					'text-color': 'hsl(227, 89%, 90%)',
					'text-opacity': ['interpolate', ['linear'], ['zoom'], 11, 0, 12, 0.8, 14, 0.8, 16, 0]
				},
				"minzoom": 11,
				"maxzoom": 16
			});

			// Add event point halos
			map.addLayer({
				id: 'points-halo',
				type: 'circle',
				source: 'events',
				filter: ['!', ['has', 'point_count']],
				paint: {
					'circle-radius': 16,
					'circle-color': 'hsl(232, 76%, 84%)',
					'circle-opacity': 0.3,
					'circle-stroke-width': 0,
					'circle-stroke-color': 'hsl(180, 21%, 5%)'
				}
			});

			// Add event points
			map.addLayer({
				id: 'points',
				type: 'circle',
				source: 'events',
				filter: ['!', ['has', 'point_count']],
				paint: {
					'circle-radius': 6,
					'circle-color': 'hsl(232, 76%, 84%)',
					'circle-stroke-width': 0,
					'circle-stroke-color': 'hsl(180, 21%, 5%)'
				}
			});

			// Add cluster circle halos
			map.addLayer({
				id: 'clusters-halo',
				type: 'circle',
				source: 'events',
				filter: ['has', 'point_count'],
				paint: {
					'circle-color': [
						'step',
						['get', 'point_count'],
						'hsl(232, 76%, 84%)',
						10, 'hsl(232, 76%, 84%)',
						25, 'hsl(232, 76%, 84%)'
					],
					'circle-opacity': 0.3,
					'circle-radius': [
						'step',
						['get', 'point_count'],
						18,
						10, 22,
						25, 26
					],
					'circle-stroke-width': 0,
					'circle-stroke-color': 'hsl(180, 21%, 5%)',
				},
				'maxzoom': zoomThreshold + 1
			});

			// Add cluster circles
			map.addLayer({
				id: 'clusters',
				type: 'circle',
				source: 'events',
				filter: ['has', 'point_count'],
				paint: {
					'circle-color': [
						'step',
						['get', 'point_count'],
						'hsl(232, 76%, 84%)',
						10, 'hsl(232, 76%, 84%)',
						25, 'hsl(232, 76%, 84%)'
					],
					'circle-radius': [
						'step',
						['get', 'point_count'],
						10,
						10, 14,
						25, 18
					],
					'circle-stroke-width': 0,
					'circle-stroke-color': 'hsl(180, 21%, 5%)',
				},
				'maxzoom': zoomThreshold + 1
			});

			// Add cluster count
			map.addLayer({
				id: 'cluster-count',
				type: 'symbol',
				source: 'events',
				filter: ['has', 'point_count'],
				layout: {
					'text-field': '{point_count_abbreviated}',
					'text-font': ['montserrat-semibold'],
					'text-size': 14,
					'text-anchor': 'center',
					'text-offset': [0, 0.13],
					'text-allow-overlap': true,
					'text-ignore-placement': true
				},
				paint: {
					'text-color': 'hsl(180, 21%, 5%)'
				},
				'maxzoom': zoomThreshold + 1
			});

			map.setLight({
				'anchor': 'viewport',
				'color': 'hsl(0, 0%, 100%)',
				'intensity': 0.5,
				'position': [1.15, 210, 20]
			});

			// Add pointer cursor for both points and clusters on hover
			map.on('mouseenter', ['points-halo', 'clusters-halo'], () => {
				map.getCanvas().style.cursor = 'pointer';
			});

			// Reset cursor when mouse leaves
			map.on('mouseleave', ['points-halo', 'clusters-halo'], () => {
				map.getCanvas().style.cursor = '';
			});

			map.once('idle', () => {
				//updateInfoBox();
				//updatePopup();
			});

		});

	</script>
</body>

</html>